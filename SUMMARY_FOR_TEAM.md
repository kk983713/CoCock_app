# CoCock_app — セッションまとめと次アクション（2025-11-10）

このドキュメントは、直近の開発セッションで議論・実装された内容、設計候補、未決事項、優先度、そして次の具体的アクションを共同作業者向けにまとめたものです。引き継ぎ用にそのまま共有・添付できます。

---

## 1) 現状サマリ（行動ログの重要点）
- ローカルで Streamlit アプリの headless 設定を保存し動作確認済み。
- CI/CD を整備し、Cloud Build → Cloud Run にデプロイできる状態（デプロイ URL は conversation_log に記録）。
- SQLite マイグレーションランナー（`db.py`）があり、`migrations/` に SQL を追加して適用する仕組み。既に `001`, `002`、および今回追加の `003_add_users_and_owner.sql` が含まれます。
- 既存コードの一部を拡張済み：`storage.py`（user-scoped path 対応）と `streamlit_app.py`（任意 username 入力→ users 作成→ owner_id を渡す処理）を変更。

## 2) 検討済み／議論中の主要項目
- 認証モデル：A. 軽量 username、B. username+password、C. OAuth（Google等）を比較。現在は本番では OAuth を推奨。ただし学習・検証は軽量方式で進められる。
- 匿名投稿：完全匿名／セッション匿名／編集トークン方式等を検討。推奨は「匿名許可 + 編集トークンを投稿時に一度だけ表示」方式（編集権保証と低障壁の両立）。
- 材料抽出とパントリー検索：段階的導入を提案。MVP は手入力＋正規化＋単純一致。以降、JSON-LD抽出→ルールベース→LLM の順で PoC を行う。
- タグベース正規化：ユーザーに canonical tag を選ばせる運用で表記ゆれをかなり抑えられる。`tags`, `tag_synonyms` テーブル導入を提案。
- 画像保存：ローカルは検証用。Cloud Run 本番では GCS などへの移行が必須（storage 抽象化の実装推奨）。

## 3) 重要な未決事項（チームで決めるべき項目）
1. 認証方針：OAuth を初期の本番方式にするか。もし Yes なら優先プロバイダ（Google / GitHub / Firebase）を決める。
2. 匿名運用：匿名投稿を許可するか、許可する場合はどの方式（編集トークンなど）を採るか。
3. 画像ストレージの切替タイミング：初期はローカルで良いか、本番前に GCS に移行するか。

## 4) 優先度（推奨）
- 最高優先：認証方針決定 → DB スキーマ（users, pantry, tags）設計 → 匿名方針決定
- 中期優先：パントリー UI・MVP マッチング実装、タグベース正規化の初期辞書導入
- 本番準備：OAuth 実装、GCS/Cloud SQL への移行、監視・ログ、セキュリティレビュー

## 5) 次の具体的アクション（PR候補）
- PR#1: 匿名投稿（編集トークン）機能
  - Migration: `dishes.author_display_name`, `dishes.edit_token`
  - UI: 投稿後に編集URLを一度だけ表示
  - ロジック: edit_token による編集認可
- PR#2: `pantry` テーブル + パントリー管理 UI
- PR#3: `tags` / `tag_synonyms` テーブル + 材料入力サジェスト
- PR#4: storage 抽象化 + GCS 実装（本番向け）

## 6) 即対応の運用項目
- 投稿フォームに CAPTCHA またはレート制限を導入（スパム対策）。
- GCP の Billing アラートを設定（運用コストの見える化）。

## 7) 相談・意思決定用の短い投票文（コピーして Slack に貼れる）
- 認証（OAuth）を本番で採用しますか？ Yes / No
- 匿名方針はどれ？ A: 完全匿名 B: セッション匿名 C: 匿名+編集トークン（推奨） D: ログイン必須
- 画像ストレージ：初期はローカルで良いか？ Yes / No

---

このファイルを `SUMMARY_FOR_TEAM.md` として保存しました。チームに共有して意思決定を集めたい場合は、私が次のアクション（PR 作成、マイグレーション作成、ドキュメント追加）を代行します。どれを優先して進めますか？

（必要であれば、このまま PR で差し出します。PR に含めるべき追加情報や担当者割り当てがあれば教えてください。）
