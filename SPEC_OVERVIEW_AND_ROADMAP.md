# CoCock_app — 全体像、現状、今後の展望（仕様書）

作成日: 2025-11-11
バージョン: 0.1-draft

目的: このドキュメントは、CoCock_app の全体像を一ページで把握できるようにし、現在の実装状態と短・中・長期のロードマップ（展望）を開発チーム／PM／経営に共有することを目的とします。

## 1. エグゼクティブサマリ
- CoCock_app は「写真中心のレシピログ」を素早く記録し、検索・整理・共有できる軽量アプリです。
- 現在は Streamlit ベースの UI、SQLite ベースの DB、ローカルファイルストレージを用いたプロトタイプが稼働中で、Cloud Run にデプロイされた環境も用意されています。
- 既に導入済みの機能: 投稿フォーム（写真・メモ・タグ）、一覧/検索、公開ギャラリー、匿名投稿の編集トークン、簡易スパム防止（honeypot・セッション制限・DB レート制限）、マイグレーション管理。

## 2. 全体アーキテクチャ（高レベル）
- フロントエンド: Streamlit（現行） → 将来的には Next.js 等のフロント分離を想定
- API / アプリ層: 現状は Streamlit 内にロジックが実装（insert/fetch 等）。将来的に FastAPI などへ切り出し可能
- DB: SQLite (`receipts.db`)（現行） → 将来的に Cloud SQL(Postgres) へ移行
- 画像ストレージ: ローカル `data/`（現行） → 将来的に GCS/S3 + 署名付き URL へ移行
- CI/CD: GitHub Actions / Cloud Build → Cloud Run にデプロイ済み（URL 確認済み）

図（簡易）:

  [Browser] <-> [Streamlit App (Streamlit + app logic)] <-> [SQLite receipts.db]
                                     |
                                     +-> data/dishes/ (local image files)

## 3. 現状（実装済み・動作確認済み）
- ローカル実行と Cloud Run デプロイの両方を検証済み
- DB マイグレーション機構 (`db.py`) とマイグレーションファイル（001–005）
  - 005 は `submission_attempts`（スパムログ）追加
- `storage.py` による画像保存パスの抽象化（ユーザー縦断パス対応）
- Streamlit UI の主要機能
  - 投稿フォーム: 写真アップロード、料理名、URL、タグ、メモ、公開フラグ
  - 匿名投稿時の UUID ベース編集トークン生成と表示
  - サイドバー: Claim（投稿をユーザーに紐付ける）・プロフィール閲覧
  - 一覧 / 検索 / 公開ギャラリー
- スパム対策（MVP レベル）
  - Honeypot フィールド
  - セッション単位の投稿制限（st.session_state）
  - DB ベースの 24h レート制限
- 運用ユーティリティ
  - start/stop/restart スクリプト（`scripts/`）
  - VS Code タスク・launch 構成（`.vscode/`）
- テスト（軽量）
  - DB レイヤでの insert/delete が動作する自動スクリプトを確認

## 4. 現在の課題・リスク（短期注意点）
1. 認証が未整備
   - 現状は任意ユーザー名と匿名トークン。将来的な OAuth 連携・セッション管理が必要
2. スパム対策が簡易
   - Honeypot 等は有効だが、公開開始前に reCAPTCHA、IP ベースのレート制御、監視を導入すべき
3. ストレージと DB のスケーラビリティ
   - SQLite とローカルファイルは同時接続や大容量に弱い
4. 編集トークンの保管 UX
   - トークンはユーザーが手動で保管する必要があり流出・紛失リスクがある
5. テストの不足
   - UI レベルの E2E（Playwright 等）と CI での自動確認が未整備

## 5. 優先度付きロードマップ（提案）

短期（0–2 週間） — 安定化 & 小改良 (Priority: High)
- 環境: CI のヘルスチェックを整備（簡易 smoke test）
- セキュリティ: reCAPTCHA をオプションで導入できるようにする（env 有効化）
- UX: 編集トークンのダウンロード/保存 UI（例: メール送信 or クリップボードコピーの案内）を追加
- 運用: ログローテーション / streamlit.log の管理、PID 管理スクリプトの改善

中期（2–8 週間） — 機能拡張と分離 (Priority: Medium)
- API 化: FastAPI などで CRUD API を用意してフロントを分離（段階的）
- 認証: NextAuth（Next.js）または OAuth プロバイダを導入
- ストレージ: GCS/S3 への移行 + 署名付き URL でフロント直アップロードを実装
- DB: Cloud SQL (Postgres) へ移行計画とマイグレーションツールの用意
- テスト: Playwright を使った E2E テストの追加

長期（2–6 ヶ月） — 製品化・スケール (Priority: Low→Medium)
- Admin / Moderation UI: スパム管理、投稿モデレーション機能
- パフォーマンス最適化: 画像 CDN、キャッシュ、クエリ最適化
- 機械学習/LLM の活用: レシピ材料抽出、タグ正規化の自動化
- マルチリージョン/可用性: Cloud Run/Cloud SQL の構成最適化

## 6. 実装プラン（短期の具体タスク）
1. reCAPTCHA のオプション実装（1–2 日）
   - 環境変数で KEY を設定した場合にフォームに検証を要求
2. 編集トークン UX 改善（1–2 日）
   - トークンのダウンロード提示、Cookie/localStorage に一時保存
3. CI smoke test（1 日）
   - サーバー起動 → ヘルスチェック → 重要 API の簡易呼び出し
4. Playwright E2E の雛形（2–4 日）

## 7. 受け入れ基準（短期タスク用）
- reCAPTCHA 有効化: 環境変数設定で CAPTCHA が画面に現れ、検証が要求されること
- トークン UX: 匿名投稿後にトークンをダウンロードまたはクリップボードコピーできること
- CI smoke: CI 実行で起動→GET / → 200 が返ること

## 8. 推奨体制・運用
- 開発: 1–2 人のエンジニアで上記短期中期タスクを循環的に実装
- 監視: エラーログを Cloud Logging/Sentry へ流す、アラートのルール設定
- コスト: GCS/Cloud SQL 移行は月額コスト増。PoC の段階ではローカル運用で費用を抑える

## 9. 次のアクション（提案）
1. 優先度 High の短期タスクを 1 週間スプリントで計画する（reCAPTCHA、トークン UX、CI smoke）
2. API 化の PoC を 2 週間のタスクとして割り当て、フロント分離の可行性を評価する
3. E2E テストを 1st シェルフに追加して継続的に回す


---
ドキュメントはドラフトです。以下は v0.2（次回リリース候補）と v0.3 以降の具体案をまとめた追記です。どの部分を優先して詳細化／実装するか指示をください。指示に沿ってタスク分解・見積り・必要なコード変更まで進めます。

## 10. v0.2（次回リリース） — 目標とスコープ（MVP 拡張）
目的: 現行プロトタイプから「公開に耐えうる最小限の安定性と UX 改善」を提供する。短期間で実装可能な改良に注力。

主要項目（必須）:
- reCAPTCHA をオプションで導入（環境変数で有効化可能） — ボット投稿の抑止
- 編集トークン UX 改善
   - 匿名投稿時に編集トークンを明確に提示
   - 「トークンをクリップボードにコピー」「トークンをファイル（txt）でダウンロード」ボタンを実装
   - Claim サイドバーでトークン紛失者向けの簡易ガイダンスを追加
- CI に簡易 smoke test を追加
   - サーバー起動 → GET / → 200 を確認する最低限のチェック

追加項目（強く推奨）:
- ログローテーション / streamlit.log の管理（ディスク使用量対策）
- start/stop スクリプトの堅牢化（PID 存在チェック・再試行）

受け入れ基準（v0.2）:
- reCAPTCHA: 環境変数を設定した状態で投稿フォームに CAPTCHA が表示され、未通過なら投稿を拒否すること
- トークン UX: 匿名投稿後に「コピー」と「ダウンロード」操作が 1 回で可能なこと（確認シナリオを Playwright で用意）
- CI smoke: CI 実行時にサーバーが起動し / が 200 を返し、テストが成功すること

工数見積り（ラフ、エンジニア 1 名想定）:
- reCAPTCHA オプション実装: 1–2 日
- トークン UX（コピー・ダウンロード）: 1 日
- CI smoke test: 0.5–1 日
- ドキュメント・リリースノート更新: 0.5 日

優先度: reCAPTCHA / トークン UX > CI smoke > ログ/スクリプト改善

## 11. v0.3（中期） — 機能強化（ユーザー体験と運用性）
目的: 認証周りと運用性を整え、マルチユーザー環境での安全運用を目指す。

主要候補:
- 認証導入（OAuth / セッション）
   - Google / GitHub などの OAuth を導入し、ユーザー毎の投稿管理を容易にする
- ストレージ移行 PoC
   - 画像を GCS/S3 に保管し、署名付き URL を用いた直接アップロードを実装
- DB 移行 PoC
   - SQLite → Cloud SQL (Postgres) への移行手順を作成、マイグレーションテスト
- スパム/モデレーション機能
   - 管理画面で submission_attempts のモニタリング、手動削除・ユーザーブロック

受け入れ基準（v0.3）:
- OAuth ログインでユーザー登録が可能で、ログインユーザーの投稿一覧が正しく表示される
- 画像アップロードが GCS/S3 に保存され、公開ページで正常に表示される

工数見積り（ラフ）:
- 認証導入: 2–4 週間（PoC→本番化の段階含む）
- ストレージ移行 PoC: 1–2 週間
- DB 移行 PoC: 1–3 週間

## 12. v0.4+（長期） — 製品化と差別化
長期ではモデレーション、スケーリング、UX の差別化に投資。LLM を用いたタグ正規化や材料抽出などの機能を検討。

## 13. リリース計画（短期）
- スプリント 0（準備, 1 日）: ブランチ戦略決定、CI タスク追加、環境変数ドキュメント整備
- スプリント 1（v0.2 実装, 1 週間）: reCAPTCHA（オプション） + トークン UX + CI smoke + ドキュメント
- リリース（デプロイ）: Cloud Run へデプロイ、動作確認、チェンジログ公開

---
次のアクション候補:
1. v0.2 の明確なスコープを確定し、優先度順に実装チケット化します（私がチケット作成可）。
2. まず reCAPTCHA とトークン UX を実装して PR を作成し、CI で smoke test を回します。
3. v0.3 の PoC（認証・GCS）を短い PoC スプリントで試し、コストと技術的リスクを評価します。

どのアクションを優先しますか？具体的に「実装を始めてほしい項目」を指示いただければ、該当コードの変更を作り始めます。

## 14. ビジョン: "AI と人の共創" への方向性（Co の拡張）
目的: CoCock の "Co" を「AI と共に」だけでなく「料理をする人たちと共に」の意味も強化し、AI を補助者／参加者として組み込みつつ、人間の経験やコミュニティ知を中心に据えたプロダクトを目指す。

### 方向性の核となる考え方
- 協働: AI は提案や整理を行うが、最終判断や個々の味付けは人が行う。AI の出力は必ず人のフィードバック（編集・評価）を得て改善される
- 透明性: AI の提案には出典や根拠（例: 元レシピURL、類似投稿のID）を明示する
- 共有と学び: ユーザー間でのレシピ改良の履歴や「共同編集（人×人）」をサポートする

### 具体機能案（v0.3 以降に段階的導入）
1. AI 提案ウィジェット（補助）
   - 投稿時または投稿後に「AI に改善案を提案してもらう」機能。例: 味付けの推定、別の調理時間や代替食材の提案
   - 提案には根拠（どの投稿や外部レシピに基づいたか）を添える

2. 共同編集 / フォーク機能
   - ある投稿を基点に他ユーザーが「フォーク」して自分のバリエーションを作成できる
   - フォーク元とのリンク、差分の可視化、マージ（提案を元に戻す）機能

3. レシピの進化トレーサビリティ
   - 投稿履歴（誰がいつ何を変えたか）を表示。AI 提案とユーザー修正を並べて比較

4. 評価と学習ループ
   - ユーザー評価（星、コメント）を AI の提案精度評価に組み込み、モデル選定やプロンプト改善にフィードバックを与える

5. コンテキストに応じた AI アシスタント
   - 冷蔵庫の残り物（ユーザーが入力）を元に「今日作れるレシピ」を提案
   - 時間・人数・アレルギー制約を考慮したレシピ最適化

### UX / UI 上の配慮
- AI の提案は「控えめに」表示し、ワンクリックで適用できる（ユーザーの編集に対して即時プレビュー）
- 提案の信頼度（スコア）と根拠を表示し、ユーザーがなぜその提案が出たか理解できるようにする
- 共同編集の UI は Git のような diff 表示ではなく、直感的な差分ハイライトとコメント機能を用いる

### 技術的インパクト / 要件
- 小規模 PoC では外部 LLM（OpenAI/GCP Vertex/同等）を API 経由で呼び出す
- ユーザーフィードバックを蓄積するための events テーブル（例: ai_feedback）を追加する
- モデル呼び出しのコスト監視とキャッシュ（提案のキャッシュ）を導入

### 受け入れ基準（例）
- AI 提案ウィジェット: ユーザーが提案を表示・適用・却下できること。適用後、保存された投稿に反映されること
- 共同編集: フォーク → 編集 → 保存 の流れがスムーズに行えること。フォーク元とのリンクが保持されること

### ロードマップへの影響
- v0.3 における優先度を「認証・ストレージ移行」と並行して「AI PoC（提案ウィジェット）」を追加する案を推奨
- まずは「表示のみの AI 提案（読み取り専用）」を PoC として導入し、UX を評価後に書き込み適用機能へ拡張する

---

このビジョンを受け、どの機能を優先的に PoC 化したいですか？（例: AI 提案ウィジェット表示のみ → 共同編集フォーク機能 → 評価フィードバック蓄積）


