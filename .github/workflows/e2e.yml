name: E2E tests

on:
  pull_request:
  push:
    branches: [ main ]

jobs:
  e2e:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install system deps
        run: |
          sudo apt-get update
          # On Ubuntu 24.04 (noble) some package names changed (libasound2 -> libasound2t64).
          # Install common dependencies needed by Playwright; use the correct package name
          # for the runner. If a package is unavailable, apt will fail â€” ensure names match the distro.
          sudo apt-get install -y --no-install-recommends \
            libnss3 libatk1.0-0 libatk-bridge2.0-0 libx11-xcb1 libgtk-3-0 libxss1 libasound2t64 || \
          sudo apt-get install -y --no-install-recommends \
            libnss3 libatk1.0-0 libatk-bridge2.0-0 libx11-xcb1 libgtk-3-0 libxss1

      - name: Install pip packages
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          # install playwright and browsers if not present
          python -m pip install playwright
          python -m playwright install --with-deps

      - name: Initialize DB (migrations + seed)
        run: |
          python scripts/test_db_init.py

      - name: Start Streamlit in background
        run: |
          ./scripts/start_streamlit.sh &
          # allow time for Streamlit to start
          sleep 4

      - name: Run E2E wrapper
        run: |
          set -eux
          bash tests/run_e2e.sh
        env:
          CI: true
          # In CI we mock Turnstile verification to avoid external dependency.
          TURNSTILE_TEST_MODE: '1'

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-artifacts
          path: |
            # root-level artifacts the E2E scripts write (legacy)
            e2e_page_content.html
            e2e_page_content2.html
            e2e_after_register.png
            e2e_after_login.png
            e2e_after_submit.png
            e2e_after_submit2.png
            streamlit.log
            # new: collect any artifacts produced under tests/e2e/artifacts/
            tests/e2e/artifacts/**
