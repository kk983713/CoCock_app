name: CI

on:
  push:
    branches: [ main ]

jobs:
  build-and-smoke:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then python -m pip install -r requirements.txt; fi

      - name: Run DB migrations (if any)
        run: |
          if [ -f db.py ]; then python db.py || true; fi

      - name: Seed public gallery sample (if none)
        run: |
          python - <<'PY'
import sqlite3, pathlib
db = pathlib.Path('receipts.db')
if db.exists():
    conn = sqlite3.connect(db)
    cur = conn.cursor()
    cur.execute("SELECT COUNT(1) FROM sqlite_master WHERE type='table' AND name='dishes'")
    if cur.fetchone()[0]==1:
        cur.execute('SELECT COUNT(1) FROM dishes WHERE is_public=1')
        cnt = cur.fetchone()[0]
        if cnt==0:
            cur.execute("INSERT INTO dishes (name,memo_user,tags,favorite,is_public,created_at,updated_at) VALUES (?,?,?,?,1,CURRENT_TIMESTAMP,CURRENT_TIMESTAMP)", ('CI Test Dish','Seeded by CI','ci-test',0))
            conn.commit()
    conn.close()
PY

      - name: Start Streamlit (background)
        run: |
          chmod +x ./streamlit_app.py || true
          nohup streamlit run streamlit_app.py --server.port 8501 > streamlit-ci.log 2>&1 &
          echo $! > streamlit.pid
          sleep 6

      - name: Smoke test HTTP
        run: |
          if ! command -v curl >/dev/null 2>&1; then sudo apt-get update && sudo apt-get install -y curl; fi
          set -e
          # try root
          for i in 1 2 3 4 5; do
            sleep 1
            if curl -sSf http://127.0.0.1:8501/ -o index.html; then break; fi
          done
          echo "== index.html head =="
          head -n 40 index.html || true
          # try to fetch a static JS referenced by index.html to ensure assets are served
          JSFILE=$(grep -oP 'src="\./static/js/\K[^"]+' index.html | head -n1 || true)
          if [ -n "$JSFILE" ]; then
            echo "Fetching static/js/$JSFILE"
            curl -sSf "http://127.0.0.1:8501/static/js/$JSFILE" -o /dev/null
          else
            echo "No static JS file found in index.html; skipping asset fetch"
          fi

      - name: Collect logs and stop Streamlit
        if: always()
        run: |
          echo "== streamlit log (tail) =="
          tail -n 200 streamlit-ci.log || true
          if [ -f streamlit.pid ]; then kill "$(cat streamlit.pid)" || true; fi
