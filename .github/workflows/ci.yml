name: CI

on:
  push:
    branches: [ main ]

jobs:
  build-and-smoke:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

    - name: Check public image files exist
    id: check_images
    continue-on-error: true
    run: |
      python scripts/check_public_images.py

      - name: Create GitHub Issue if images missing
        if: steps.check_images.outcome == 'failure'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          ISSUE_LABELS: ${{ secrets.ISSUE_LABELS }}
          ISSUE_ASSIGNEES: ${{ secrets.ISSUE_ASSIGNEES }}
        run: |
          python scripts/create_issue.py

      - name: Slack notify if images missing
        if: steps.check_images.outcome == 'failure'
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
          REPO: ${{ github.repository }}
        run: |
          if [ -z "${SLACK_WEBHOOK}" ]; then echo "No SLACK_WEBHOOK provided; skipping Slack notify"; exit 0; fi
          MISSING_JSON='missing.json'
          if [ ! -f "$MISSING_JSON" ]; then echo "no missing.json; skipping"; exit 0; fi
          RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          MSG="CI detected missing public images in ${REPO}: ${RUN_URL}"
          PAYLOAD=$(jq -n --arg text "$MSG" '{text: $text}')
          curl -sSf -X POST -H 'Content-type: application/json' --data "$PAYLOAD" "$SLACK_WEBHOOK" || true

      - name: Collect logs and stop Streamlit
        if: always()
        run: |
          echo "== streamlit log (tail) =="
          tail -n 200 streamlit-ci.log || true
          if [ -f streamlit.pid ]; then kill "$(cat streamlit.pid)" || true; fi
