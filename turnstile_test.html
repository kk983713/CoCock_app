<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Turnstile token fetcher</title>
    <script src="https://challenges.cloudflare.com/tur    # コンテナ内部だけで使う/ホストからは127.0.0.1でOK
    python3 scripts/token_store.py --host 127.0.0.1 --port 8765
    
    # ホストのブラウザからアクセスするなら（DevContainer の場合）
    python3 scripts/token_store.py --host 0.0.0.0 --port 8765nstile/v0/api.js" async defer></script>
    <style>
      body{font-family:system-ui, -apple-system, Roboto, 'Helvetica Neue', Arial; padding:24px; max-width:920px;}
      #token{width:100%; height:120px;}
      .box{margin-bottom:16px;}
      button { padding:8px 12px; }
    </style>
  </head>
  <body>
    <h2>Turnstile Token Fetcher (PoC)</h2>
    <p class="box">サイトキーを使って Turnstile ウィジェットを表示します。ウィジェットを操作すると下の textarea にトークンが入ります。</p>
    <!-- Replace YOUR_SITE_KEY with the Turnstile site key from Cloudflare -->
    <div id="widget" class="cf-turnstile" data-sitekey="0x4AAAAAACAfGXNtNwOU2l1b" data-callback="onToken" data-theme="light"></div>

    <p class="box"><strong>Token (コピーして Streamlit の PoC フォームに貼ってください)</strong></p>
    <textarea id="token" readonly></textarea>
    <p>
      <button id="copyBtn">クリップボードにコピー</button>
      <button id="openStreamlit">Streamlit を開く（localhost:8501）</button>
      <button id="postToStore">トークンをローカルに保存して短いIDで開く（推奨）</button>
    </p>
    <div style="margin-top:12px;">
      <label for="storeUrl">token_store URL (開発用)</label>
      <input id="storeUrl" value="http://127.0.0.1:8765" style="width:60%" />
      <div id="storeResult" style="margin-top:8px;color:#111"></div>
    </div>

    <script>
      function onToken(token) {
        document.getElementById('token').value = token;
        console.log('turnstile token:', token);
      }
      document.getElementById('copyBtn').addEventListener('click', async () => {
        const t = document.getElementById('token').value;
        if (!t) { alert('先にウィジェットを完了してください'); return; }
        try {
          await navigator.clipboard.writeText(t);
          alert('トークンをコピーしました。Streamlit のフォームに貼って送信してください。');
        } catch (e) {
          prompt('クリップボードにコピーできませんでした。トークンを手動でコピーしてください:', t);
        }
      });
      document.getElementById('openStreamlit').addEventListener('click', () => {
        const t = document.getElementById('token').value;
        if (!t) { alert('先にウィジェットを完了してトークンを取得してください'); return; }
        // そのままフルトークンをクエリパラメータで渡す（短期的な方法、長い値でフロントエンドに影響することがあります）
        const url = `http://localhost:8501/?turnstile_token=${encodeURIComponent(t)}`;
        window.open(url, '_blank');
      });

      // 推奨: トークンをローカルの token_store に POST して短い id を受け取り、それを Streamlit に渡す
      document.getElementById('postToStore').addEventListener('click', async () => {
        const t = document.getElementById('token').value;
        if (!t) { alert('先にウィジェットを完了してトークンを取得してください'); return; }
        try {
          const storeUrl = document.getElementById('storeUrl') ? document.getElementById('storeUrl').value || 'http://127.0.0.1:8765' : 'http://127.0.0.1:8765';
          const resp = await fetch(storeUrl.replace(/\/$/, '') + '/store', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ token: t })
          });
          if (!resp.ok) {
            const txt = await resp.text();
            document.getElementById('storeResult').textContent = 'token_store error: ' + txt;
            return;
          }
          const j = await resp.json();
          if (!j.id) { document.getElementById('storeResult').textContent = 'token_store did not return id'; return; }
          const shortId = j.id;
          document.getElementById('storeResult').textContent = 'stored id: ' + shortId + ' (有効期限約5分、一度だけ取得されます)';
          try { await navigator.clipboard.writeText(shortId); } catch (e) { /* ignore */ }
          // short id をクエリで渡す (短いためフロントエンド破壊リスクが低い)
          const url = `http://localhost:8501/?turnstile_token_id=${encodeURIComponent(shortId)}`;
          window.open(url, '_blank');
        } catch (e) {
          alert('Error posting token to local store: ' + e);
        }
      });
    </script>
  </body>
</html>
