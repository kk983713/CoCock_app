# レシピログ MVP 仕様メモ

## 1. ゴール (MVP)
- スマホから 1 分で料理を記録（写真 / 料理名 / URL / メモ）。
- 登録後に AI 要約を生成しカードへ表示。
- 要約に含める要素：
  - 材料（正規化・数量推定）。
  - 手順の 3〜6 行サマリ。
  - 次回の改善案 (Tips)。
  - タグ（例：和食・10分・鶏肉・冬）。
- 一覧で検索（料理名 / タグ / お気に入り）＋「また作りたい」フィルタ。

## 2. 推奨アーキテクチャ (初期)
- フロント：Streamlit（スマホ最適化 / PWA 想定）。
- バックエンド：Python（FastAPI または Streamlit 内関数）。
- DB：SQLite（将来的に Firestore へ移行可能）。
- ストレージ：ローカル `photos`（将来的に Cloud Storage）。
- AI：OpenAI または Gemini。
- スクレイピング：`requests` + `BeautifulSoup`（抽出不可なら AI 抽出）。

```
[スマホ UI (Streamlit)]
   ├─ 写真アップ / URL / メモ 送信
   ↓
[サーバ (Python)]
   ├─ レシピ HTML 取得 → 材料 / 手順抽出（規則 / AI）
   ├─ AI 要約生成（プロンプト）
   ├─ タグ抽出・正規化
   └─ DB 保存（要約 / タグ / インデックス）
```

## 3. データモデル (MVP)
`dishes` テーブル
- `id` (PK)
- `name` (TEXT) … 料理名（手入力 or AI 補完）
- `date` (TEXT, ISO8601)
- `photo_path` (TEXT)
- `recipe_url` (TEXT, nullable)
- `memo_user` (TEXT) … ユーザー自由記述
- `ai_summary` (TEXT) … 料理要約（手順 3–6 行）
- `ai_tips` (TEXT) … 次回の改善点 / 代替案
- `ingredients_json` (TEXT) … JSON 配列（下記スキーマ）
- `tags` (TEXT) … カンマ区切り（例：`和食,10分,鶏肉`）
- `favorite` (INTEGER, 0/1)

`ingredients_json` 例：
```json
[
  {"name_norm": "鶏むね肉", "qty": 200, "unit": "g", "role": "主材"},
  {"name_norm": "玉ねぎ", "qty": 0.5, "unit": "個", "role": "副材"},
  {"name_norm": "醤油", "qty": 2, "unit": "tbsp", "role": "調味"}
]
```

## 3.1 `dishes` テーブル詳細 (v0.1)
| 列名 | 型 | 必須 | 初期値 | 説明 |
| --- | --- | --- | --- | --- |
| `id` | INTEGER | 自動採番 | - | 主キー。登録順の識別子。 |
| `name` | TEXT | 任意 | 空文字 | ユーザー入力または後で AI が補完。 |
| `date` | TEXT | 任意 | 登録時に `datetime.now().isoformat()` を保存 | 調理日付。後から編集で上書き可能。 |
| `photo_path` | TEXT | 任意 | `NULL` | 画像ファイルの相対パス。写真が無い場合は `NULL`。 |
| `recipe_url` | TEXT | 任意 | `NULL` | 参考レシピの URL。 |
| `memo_user` | TEXT | 任意 | 空文字 | ユーザーの自由メモ。 |
| `ai_summary` | TEXT | 任意 | `NULL` | v0.3 以降で利用予定の要約。 |
| `ai_tips` | TEXT | 任意 | `NULL` | v0.3 以降で利用予定の改善案。 |
| `ingredients_json` | TEXT | 任意 | `NULL` | 材料リストを JSON 文字列で格納。 |
| `tags` | TEXT | 任意 | 空文字 | カンマ区切りのタグ。 |
| `favorite` | INTEGER | 必須 | `0` | お気に入りフラグ（0/1）。 |
| `created_at` | TEXT | 必須 | デフォルトで `CURRENT_TIMESTAMP` | 登録日時。 |
| `updated_at` | TEXT | 必須 | デフォルトで `CURRENT_TIMESTAMP`、更新時にトリガーで自動更新 | 最終更新日時。 |

SQLite では真偽値を 0/1 の整数で扱う。`created_at` / `updated_at` は標準の `CURRENT_TIMESTAMP` を使用し、更新時には `updated_at` を上書きする小さなトリガーを用意する。

## 3.2 マイグレーション方針
- v0.1 では単純な初期化処理を Python から呼び出し、アプリ起動時に `CREATE TABLE IF NOT EXISTS dishes (...)` を実行してテーブルを作成する。既存の `receipts.db` に共存させる。
- スキーマ変更が発生したら、`migrations/` 配下にバージョン付きの SQL ファイル（例：`001_create_dishes.sql`、`002_add_ai_columns.sql`）を置き、最新まで順番に実行するユーティリティ関数を準備する。
- 各マイグレーションの実行履歴を記録する管理テーブル（例：`schema_migrations(version TEXT PRIMARY KEY)`）を作り、同じスクリプトを複数回走らせても二重適用されないようにする。
- 将来 Firestore 等へ移行する場合も、SQLite スキーマの最新版が設計書として参照できるよう、このディレクトリ構成で履歴を残す。

## 3.3 写真保存ルール
- 基本の保存先は `data/dishes/<dish_id>/cover.<ext>`。`<dish_id>` は登録後に確定する数値 ID、`<ext>` はアップロード元の拡張子（jpg/png など）を小文字で使用。拡張子が取れない場合は `.jpg` を使用。
- `storage.py` にユーティリティ関数を用意：
  - `ensure_storage_dirs()`：`data/` と `data/dishes/` フォルダを作成。
  - `build_dish_photo_path(dish_id, original_filename)`：料理 ID ごとの保存パスを計算し、必要なディレクトリも作成。
- 将来サブ写真を増やしたい場合は `data/dishes/<dish_id>/step_<n>.<ext>` のように命名し、`cover` を表紙写真として扱う。
- `photo_path` 列には上記パスを相対パスで保存し、アプリから参照・表示する。

## 4. AI 要約：プロンプト設計
### 目的
HTML / URL / メモから「要約・材料正規化・手順・Tips・タグ」を一括生成（JSON）。短く・構造化・決め打ちスキーマ・フラットトーン。

### System (固定)
```
あなたは料理アーカイブの編集者です。

出力は日本語、以下の JSON スキーマに厳密準拠。

不明な数量は平均的家庭料理の一般量で埋め、"confidence": "low" を付与。
```

### User (動的)
```
入力：

Recipe_URL: {url or null}
Extracted_HTML_Text: {text 〜3,000 字に要約した本文}
User_Memo: {free text or ""}
Dish_Name: {user input or ""}
```

### JSON スキーマ（出力）
```json
{
  "dish_name_suggest": "string",
  "summary": "string (3-6文)",
  "ingredients": [
    {"name_norm":"string", "qty": number|null, "unit":"string|null", "role":"主材|副材|調味", "confidence":"high|mid|low"}
  ],
  "steps_bullets": ["string","string","string"],
  "next_tips": ["string","string"],
  "tags": ["和食","10分","鶏肉","冬"]
}
```

### ガードルール
- URL が無効・取得不可なら `User_Memo` と `Dish_Name` を中心に生成。
- 不確かな値は `confidence: "low"` を付与し、創作しない。
- タグは最大 6 つ、重複禁止、一般語を優先。

## 5. 取得・抽出戦略（URL→材料/手順）
1. HTML 抽出の規則ベース（高精度サイト向け）  
   - `itemprop="recipeIngredient"` / `itemprop="recipeInstructions"` / `schema.org/Recipe`。  
   - 抽出に成功した場合、AI は正規化と要約のみ担当。
2. 規則で取れない場合  
   - 本文テキスト 3,000 字に要約 → AI で材料・手順抽出。
3. URL なし  
   - ユーザーメモ＋料理名から AI が雛形生成（家庭的一般レシピ）。

## 6. UI フロー（スマホ 1 分登録）
- 画面 A（登録）：写真撮影 / 選択 → 料理名（任意） → URL（任意） → メモ（任意） → 送信 → 「登録しました。AI 要約を生成中…」表示 → 非同期でカードへ反映。
- 画面 B（一覧 / 検索）：タブ（すべて / お気に入り / タグ）、クイック検索（名前・タグ）、カード（写真・要約 3 行・タグ・⭐・詳細）。
- 画面 C（詳細）：要約・材料（数量）・手順・ Tips・URL プレビュー・編集ボタン。

## 7. 失敗時の設計（レジリエンス）
- HTML 取得失敗：AI はメモと名前のみで生成、カードに「URL 解析失敗（再試行）」バッジ。
- AI 応答失敗 / 遅延：カードをプレースホルダ表示、後から差し替え。
- 数量不明：単位は `null` 可、`confidence: "low"` 明示。
- 写真なしでも登録可（テキストのみ）。

## 8. コスト / 速度最適化
- プロンプトを短く（HTML は抽出済み本文の要点のみ）。
- 2 段階推論を避け、1 プロンプトで JSON 一発生成。
- キャッシュ：同一 URL はハッシュキーで要約再利用。
- モデル選択：
  - 下書き：軽量モデル（コスト削減）。
  - 詳細ページ開封時のみ高性能モデルで上書き精緻化。
- レート制御：登録直後はジョブキュー処理（例：3 本/秒）。

## 9. セキュリティ / プライバシ
- API キーはサーバ側のみに保持。
- 画像はユーザー固有ディレクトリに保存し、推測困難なファイル名を利用。
- 公開共有はデフォルト OFF、共有リンクは期限付きトークン。
- 個人情報を AI に送らない（氏名 / 住所 / 顔の識別）。

## 10. QA 観点（MVP 検証チェックリスト）
- スマホ 1 分で登録できるか（タップ数・待ち時間）。
- 要約の短さ / 要点性（3–6 文に収まる）。
- 材料の正規化精度（大さじ / 小さじ / tsp / tbsp / 杯 / 個 / g で統一）。
- タグの一貫性（最大 6、重複なし、ジャンル×食材×時間×季節のバランス）。
- 再現性：同じ URL で同等の JSON が出るか（キャッシュ）。
- 失敗時の UX が破綻しない（後追い更新・リトライ導線）。

## 11. リリース順序
1. v0.1：登録 → 一覧 → 詳細（AI なし）。
2. v0.2：URL 規則抽出を導入（成功時は AI 最小化）。
3. v0.3：AI 要約（一発 JSON）導入、タグ / 材料 / 手順 / Tips 表示。
4. v0.4：モバイル最適化＋お気に入り＋検索。
5. v0.5：PWA 対応（ホーム追加・オフライン簡易閲覧）。

## 11.1 v0.1 実装スコープ
- **目的**：AI なしで「登録→一覧→詳細」の基本フローを成立させる。スマホから 1 分で記録できる UX の骨格を固める。
- **フロント (Streamlit)**：
  - 画面 A：写真アップロード、料理名、URL、メモを入力し送信。
  - 画面 B：登録済みカードの一覧表示（最新順）、簡易検索（料理名部分一致）。
  - 画面 C：詳細ビューで写真・基本情報・メモを表示、編集・削除ボタンを配置（編集は v0.1 では未実装でも可、ボタンはプレースホルダ）。
- **バックエンド (Python)**：
  - POST エンドポイントまたは Streamlit アクションで `dishes` テーブルへ保存。
  - 画像ファイル保存ロジックと `photo_path` の永続化。
  - 一覧取得（ページングは不要）、詳細取得 API。
- **データモデル / マイグレーション**：
  - `dishes` テーブルの作成（v0.1 では AI 関連カラムは nullable のまま保持）。
  - メモリ/ディスク上の SQLite 初期化と接続ユーティリティ。
- **非機能**：
  - スマホ表示でフォームが縦並びになる簡易レスポンシブ調整。
  - 登録成功・失敗時のトースト / アラート。
- **除外事項 (v0.2 以降に回す)**：
  - AI 要約生成、タグ管理、材料正規化。
  - 自動スクレイピング処理。
  - お気に入り・「また作りたい」フィルタ。
  - キャッシュ・ジョブキュー・PWA 化。
- **完了条件**：
  - 写真付きの記録が登録・参照できる。
  - フォーム送信が 1 分以内に完了する操作性。
  - 主要ブラウザのスマホ表示で致命的な崩れがないことを確認。

## 12. “らしさ”の演出
- カードのフッターに「一言の思い出」を AI 抽出（12〜18 文字）。例：「湯気の立つ夜」「冬の台所の音」。
- 年末に「わたしの食の回想録」を自動生成（Top10・季節・食材傾向）。
